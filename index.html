<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Salon Pro ‚Äî Dashboard Avanzado</title>
  <style>
    /* ====== CSS Base / Theming ====== */
    :root {
      --bg:#0f0f12;
      --fg:#ffffff;
      --muted:#a7a7b1;
      --primary:#6ee7b7;
      --topbar:#15151b;
      --card:#1a1b23;
      --btn:#26283a;
      --accent:#93c5fd;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";

      --menu-radius:16px;
      --menu-blur:10px;
      --menu-shadow:0 10px 30px rgba(0,0,0,.35);
      --menu-card:rgba(255,255,255,.04);
      --menu-border:1px solid rgba(255,255,255,.10);
      --menu-cols:2;
      --menu-icon:22px;
    }
    * { box-sizing:border-box; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:var(--font); }
    .hidden { display: none !important; }
    .topbar {
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:.6rem;
      padding:.6rem .9rem; background:var(--topbar); border-bottom:1px solid #00000055;
    }
    .logo { width:34px; height:34px; border-radius:6px; object-fit:contain; background:#0003; display:inline-block; }
    .title { font-weight:700; letter-spacing:.2px; }
    .spacer { flex:1; }
    .btn {
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.55rem .8rem; border-radius:10px; border:1px solid #00000066;
      background:var(--btn); color:var(--fg); cursor:pointer; font-weight:600;
    }
    .btn.small { padding:.35rem .6rem; font-size:.9rem; border-radius:8px; }
    .btn.ghost { background:transparent; }
    .btn.primary { background:var(--accent); }
    .btn.ok { background:var(--ok); }
    .btn.warn { background:var(--warn); }
    .btn.danger { background:var(--danger); }
    .container { max-width:1000px; margin:1rem auto; padding:0 1rem; }
    .card {
      background: linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px; padding:1rem; margin:.7rem 0;
      box-shadow:0 12px 28px rgba(0,0,0,.28);
    }
    .grid { display:grid; gap:1rem; }
    .grid.two { grid-template-columns:repeat(2,minmax(0,1fr)); }
    .grid.three { grid-template-columns:repeat(3,minmax(0,1fr)); }
    label { display:block; margin:.4rem 0 .2rem; color:var(--muted); font-size:.9rem; }
    input, select, textarea {
      width:100%; padding:.55rem .6rem; border-radius:10px; border:1px solid #00000055;
      background:#0f1017; color:var(--fg);
    }
    input[type="color"] { padding:.2rem; height:38px; }
    .row { display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
    .kbd { background:#0002; border:1px solid #0003; border-radius:6px; padding:.1rem .35rem; font-size:.85rem; }

    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th,td { padding:.55rem; border-bottom:1px solid #00000055; font-size:14px; }
    th { color:var(--muted); text-align:left; }

    /* Print styles */
    @media print {
      body { background:#fff; color:#000; }
      .topbar, .btn, .no-print { display:none !important; }
      .card { border:1px solid #ddd; }
    }

    .login-wrap { display:flex; align-items:center; justify-content:center; min-height:70vh; }
  </style>
</head>
<body>
  <div class="topbar no-print">
    <img id="logoTop" class="logo" alt="logo">
    <div class="title" id="salonName">Mi Sal√≥n</div>
    <span class="spacer"></span>
    <button class="btn small" id="btnDashboard">üè† Men√∫</button>
    <button class="btn small" id="btnLogout" title="Cerrar sesi√≥n">üîì Salir</button>
  </div>

  <div class="container">
    <!-- Login -->
    <section id="viewLogin" class="login-wrap">
      <div class="card" style="min-width:320px; max-width:420px">
        <div class="row" style="align-items:center; gap:.7rem;">
          <img id="logoLogin" class="logo" alt="logo">
          <div>
            <div style="font-weight:800" id="salonNameLogin">Mi Sal√≥n</div>
            <small style="opacity:.7">Acceso</small>
          </div>
        </div>
        <hr>
        <label>Usuario</label>
        <input id="loginUser" placeholder="usuario">
        <label>Contrase√±a</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <div class="row" style="margin-top:.7rem">
          <button class="btn ok" id="btnDoLogin">Ingresar</button>
        </div>
      </div>
    </section>

    <!-- Men√∫ principal -->
    <section id="viewMenu" class="hidden">
      <div class="row">
        <div class="card" style="flex:1">
          <h2>Men√∫</h2>
          <div id="menuList" class="grid two no-print"></div>
        </div>
      </div>
    </section>

    <!-- Cobros / Facturas -->
    <section id="viewBilling" class="hidden">
      <div class="row"><button class="btn ghost no-print" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="grid two">
        <div class="card">
          <h3>Nuevo cobro / factura</h3>
          <div class="grid two">
            <div><label>Fecha</label><input type="date" id="invDate"></div>
            <div><label>Hora</label><input type="time" id="invTime"></div>
            <div><label>Cliente</label><input id="invClient"></div>
            <div><label>T√©cnica</label><select id="invTech"></select></div>
            <div><label>M√©todo de pago</label><select id="invPay"><option>Cash</option><option>Tarjeta</option><option>ATH M√≥vil</option></select></div>
            <div><label>Monto</label><input id="invAmount" type="number" step="0.01"></div>
          </div>
          <div class="row" style="margin-top:.6rem">
            <button class="btn ok" id="btnSaveInv">üíæ Guardar factura</button>
            <button class="btn small" id="btnInvoicePDF">üñ®Ô∏è PDF factura</button>
          </div>
        </div>

        <div class="card">
          <h3>Historial de cobros</h3>
          <div class="row no-print">
            <button class="btn small" id="btnExportInvPDF">üñ®Ô∏è PDF general</button>
            <button class="btn small" id="btnExportInvCSV">üìÑ CSV general</button>
            <input type="file" id="importInvJSON" accept="application/json">
          </div>

          <div class="card">
            <label>T√©cnica</label>
            <select id="invTechFilter" title="Filtrar por t√©cnica"></select>
            <label>Periodo</label>
            <select id="invPeriodFilter" title="Filtrar por periodo">
              <option value="all">Todo</option>
              <option value="today">Hoy</option>
              <option value="this_month">Este mes</option>
              <option value="this_year">Este a√±o</option>
            </select>
          </div>

          <div class="row no-print" style="flex-wrap:wrap; gap:.5rem;">
            <button class="btn small" id="btnTechDayPDF">PDF D√≠a (T√©cnica)</button>
            <button class="btn small" id="btnTechDayCSV">CSV D√≠a (T√©cnica)</button>

            <button class="btn small" id="btnTechMonthPDF">PDF Mes (T√©cnica)</button>
            <button class="btn small" id="btnTechMonthCSV">CSV Mes (T√©cnica)</button>

            <button class="btn small" id="btnTechYearPDF">PDF A√±o (T√©cnica)</button>
            <button class="btn small" id="btnTechYearCSV">CSV A√±o (T√©cnica)</button>

            <button class="btn small" id="btnExportInvByTechPDF">PDF por T√©cnica</button>
            <button class="btn small" id="btnExportInvByTechCSV">CSV por T√©cnica</button>
            <button class="btn small" id="btnExportInvByDayPDF">PDF por D√≠a</button>
            <button class="btn small" id="btnExportInvByDayCSV">CSV por D√≠a</button>
          </div>

          <table id="tblInv"></table>
        </div>
      </div>
    </section>

  </div>

  <script>
    // Utilidades & estado
    const S = {
      key: k => `salon.${k}`,
      load: (k, def) => { try { return JSON.parse(localStorage.getItem(S.key(k))) ?? def; } catch(e) { return def; } },
      save: (k, v) => localStorage.setItem(S.key(k), JSON.stringify(v)),
      uid: () => Math.random().toString(36).substr(2,9),
      today: () => new Date().toISOString().slice(0,10),
      nowTime: () => new Date().toTimeString().substr(0,5),
      pad: n => String(n).padStart(2,'0'),
      csv: rows => rows.map(r=>r.map(x=>`"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n'),
      download: (name, content, type='application/octet-stream') => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([content], { type }));
        a.download = name;
        a.click();
        URL.revokeObjectURL(a.href);
      },
      isSameDay: (a,b) => a.toISOString().slice(0,10) === b.toISOString().slice(0,10)
    };

    const state = {
      session: S.load('session', null),
      users: S.load('users', [
        { user:'admin', pass:'admin', role:'admin' },
        { user:'user', pass:'user', role:'user' }
      ]),
      techs: S.load('techs', ['General']),
      invoices: S.load('invoices', []),
      cfg: S.load('cfg', { invoice:{ prefix:'INV-', next:1 } })
    };

    function persistAll(){
      S.save('session', state.session);
      S.save('users', state.users);
      S.save('techs', state.techs);
      S.save('invoices', state.invoices);
      S.save('cfg', state.cfg);
    }

    // Manejo de vistas simples
    const views = {
      login: document.getElementById('viewLogin'),
      menu: document.getElementById('viewMenu'),
      billing: document.getElementById('viewBilling')
    };

    function showView(name){
      for(let v in views){
        if(views[v]) views[v].classList.add('hidden');
      }
      views[name].classList.remove('hidden');
      document.getElementById('btnLogout').style.display = state.session ? 'inline-block' : 'none';
    }

    window.onload = ()=>{
      applyTechsFilter();
      renderInvoices();
      if(state.session){
        showView('viewBilling');
        document.getElementById('salonName').textContent = state.cfg.invoice.prefix;
      } else {
        showView('viewLogin');
      }
    };

    // Login / Logout
    document.getElementById('btnDoLogin').onclick = ()=>{
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value.trim();
      const f = state.users.find(x=>x.user===u && x.pass===p);
      if(f){
        state.session = { user:f.user, role:f.role };
        persistAll();
        showView('viewBilling');
      } else {
        alert('Usuario o contrase√±a incorrectos');
      }
    };
    document.getElementById('btnLogout').onclick = ()=>{
      state.session = null;
      persistAll();
      showView('viewLogin');
    };

    // Rellenar t√©cnicas
    function applyTechsFilter(){
      const selTech = document.getElementById('invTech');
      const f = document.getElementById('invTechFilter');
      if(selTech){
        selTech.innerHTML = state.techs.map(t=>`<option value="${t}">${t}</option>`).join('');
      }
      if(f){
        f.innerHTML = ['(todas)', ...state.techs].map(t=>`<option value="${t}">${t}</option>`).join('');
      }
    }

    // Guardar factura
    document.getElementById('btnSaveInv').onclick = ()=>{
      const date = document.getElementById('invDate').value;
      const time = document.getElementById('invTime').value;
      const client = document.getElementById('invClient').value.trim();
      const tech = document.getElementById('invTech').value;
      const pay = document.getElementById('invPay').value;
      const amount = parseFloat(document.getElementById('invAmount').value) || 0;
      if(!date || !time || !client || amount <= 0){
        alert('Completa fecha, hora, cliente y monto.');
        return;
      }
      const num = `${state.cfg.invoice.prefix}${String(state.cfg.invoice.next).padStart(4,'0')}`;
      state.invoices.push({ id:S.uid(), number:num, date, time, client, tech, pay, amount });
      state.cfg.invoice.next++;
      persistAll();
      renderInvoices();
    };

    // Render tabla de facturas
    function renderInvoices(){
      const tbl = document.getElementById('tblInv');
      tbl.innerHTML = '<tr><th>N√∫mero</th><th>Fecha</th><th>Hora</th><th>Cliente</th><th>T√©cnica</th><th>M√©todo</th><th>Monto</th></tr>' +
        state.invoices.map(i=>`
          <tr>
            <td>${i.number}</td>
            <td>${i.date}</td>
            <td>${i.time}</td>
            <td>${i.client}</td>
            <td>${i.tech}</td>
            <td>${i.pay}</td>
            <td>$${i.amount.toFixed(2)}</td>
          </tr>`).join('');
    }

    // Obtener rango de periodo
    function getPeriodRange(period){
      const now = new Date();
      const startDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const startMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const startYear = new Date(now.getFullYear(), 0, 1);
      if(period==='today') return { from: startDay, to: new Date(startDay.getFullYear(), startDay.getMonth(), startDay.getDate()+1) };
      if(period==='this_month') return { from: startMonth, to: new Date(now.getFullYear(), now.getMonth()+1, 1) };
      if(period==='this_year') return { from: startYear, to: new Date(now.getFullYear()+1, 0, 1) };
      return null; // 'all'
    }

    // Agrupar facturas
    function groupInvoices(mode, opts={}){
      const tech = opts.tech || '(todas)';
      const period = opts.period || 'all';
      let list = state.invoices.slice();
      const pr = getPeriodRange(period);
      if(pr){
        list = list.filter(i=>{
          const d = new Date(i.date);
          return (!pr.from || d >= pr.from) && (!pr.to || d < pr.to);
        });
      }
      if(tech && tech!=='(todas)'){
        list = list.filter(i=> i.tech === tech);
      }

      const map = {};
      list.forEach(i=>{
        let key;
        switch(mode){
          case 'tech': key = i.tech; break;
          case 'day': key = i.date; break;
          case 'month': key = i.date.slice(0,7); break;
          case 'year': key = i.date.slice(0,4); break;
          default: key = '(otros)';
        }
        if(!map[key]) map[key] = { key:key, count:0, total:0 };
        map[key].count++;
        map[key].total += i.amount;
      });
      return Object.values(map).sort((a,b)=> b.total - a.total);
    }

    function exportInvGroupedCSV(mode, opts={}){
      const tech = opts.tech || '(todas)';
      const period = opts.period || 'all';
      const data = groupInvoices(mode, { tech, period });
      const header = [['Clave','Cantidad','Total']];
      const rows = data.map(r=>[r.key, r.count, r.total.toFixed(2)]);
      const csvContent = S.csv(header.concat(rows));
      const filename = `cobros-${mode}-${tech}-${period}-${Date.now()}.csv`;
      S.download(filename, csvContent, 'text/csv');
    }

    function exportInvGroupedPDF(mode, opts={}){
      const tech = opts.tech || '(todas)';
      const period = opts.period || 'all';
      const data = groupInvoices(mode, { tech, period });
      let sumTotal = 0, sumCount = 0;
      data.forEach(r=>{ sumTotal += r.total; sumCount += r.count; });

      const niceMode = mode==='tech'?'T√©cnica':
                       mode==='day'?'D√≠a':
                       mode==='month'?'Mes':
                       mode==='year'?'A√±o':
                       mode;

      const rngLabel = (period==='today'?'Hoy':period==='this_month'?'Este mes':period==='this_year'?'Este a√±o':'Todo');

      const rowsHtml = data.map(r=>`
        <tr>
          <td>${r.key}</td>
          <td style="text-align:right">${r.count}</td>
          <td style="text-align:right">$${r.total.toFixed(2)}</td>
        </tr>
      `).join('');

      const html = `
        <html><head><meta charset="utf-8"><title>Cobros agrupados ${niceMode}</title>
          <style>
            @page { size:A4 landscape; margin:12mm }
            body{ font-family:sans-serif; color:#111 }
            table{ width:100%; border-collapse:collapse; font-size:12px }
            th,td{ border:1px solid #ccc; padding:6px; }
            th{ background:#f3f3f3; }
            tfoot td{ font-weight:bold; background:#eee; }
          </style>
        </head><body>
          <h1>Cobros agrupados por ${niceMode}</h1>
          <div>Per√≠odo: ${rngLabel} ¬∑ T√©cnica: ${tech}</div>
          <table>
            <thead><tr><th>${niceMode}</th><th>Cantidad</th><th>Total</th></tr></thead>
            <tbody>${rowsHtml}</tbody>
            <tfoot><tr><td>TOTAL</td><td>${sumCount}</td><td>$${sumTotal.toFixed(2)}</td></tr></tfoot>
          </table>
        </body></html>
      `;
      const w = window.open('','print');
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }

    function currentTechFilter(){
      return document.getElementById('invTechFilter')?.value || '(todas)';
    }
    function currentPeriodFilter(){
      return document.getElementById('invPeriodFilter')?.value || 'all';
    }

    document.getElementById('btnTechDayCSV').onclick = ()=>exportInvGroupedCSV('day',{tech:currentTechFilter(), period:currentPeriodFilter()});
    document.getElementById('btnTechDayPDF').onclick = ()=>exportInvGroupedPDF('day',{tech:currentTechFilter(), period:currentPeriodFilter()});
    document.getElementById('btnTechMonthCSV').onclick = ()=>exportInvGroupedCSV('month',{tech:currentTechFilter(), period:currentPeriodFilter()});
    document.getElementById('btnTechMonthPDF').onclick = ()=>exportInvGroupedPDF('month',{tech:currentTechFilter(), period:currentPeriodFilter()});
    document.getElementById('btnTechYearCSV').onclick = ()=>exportInvGroupedCSV('year',{tech:currentTechFilter(), period:currentPeriodFilter()});
    document.getElementById('btnTechYearPDF').onclick = ()=>exportInvGroupedPDF('year',{tech:currentTechFilter(), period:currentPeriodFilter()});

    document.getElementById('btnExportInvByTechCSV').onclick = ()=>exportInvGroupedCSV('tech',{tech:currentTechFilter(), period:currentPeriodFilter()});
    document.getElementById('btnExportInvByTechPDF').onclick = ()=>exportInvGroupedPDF('tech',{tech:currentTechFilter(), period:currentPeriodFilter()});
    document.getElementById('btnExportInvByDayCSV').onclick = ()=>exportInvGroupedCSV('day',{tech:'(todas)', period:currentPeriodFilter()});
    document.getElementById('btnExportInvByDayPDF').onclick = ()=>exportInvGroupedPDF('day',{tech:'(todas)', period:currentPeriodFilter()});

  </script>
</body>
</html>
