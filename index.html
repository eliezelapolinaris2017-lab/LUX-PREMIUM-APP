<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Salon Pro — Dashboard</title>
  <style>
    /* Estilos básicos */
    body { margin:0; font-family: Arial, sans-serif; background:#121212; color:#fff; }
    .hidden { display:none; }
    .container { max-width:900px; margin:20px auto; padding:10px; }
    .btn { padding:8px 12px; background:#4caf50; color:#fff; border:none; cursor:pointer; margin:4px; }
    .btn.danger { background:#f44336; }
    .topbar { background:#1a1a1a; padding:10px; display:flex; align-items:center; }
    .spacer { flex:1; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { padding:8px; border:1px solid #444; }
    input, select { padding:6px; margin:4px 0; width:100%; box-sizing:border-box; background:#222; color:#fff; border:1px solid #555; }
    label { margin-top:8px; display:block; }
  </style>
</head>
<body>
  <div class="topbar">
    <div id="salonName">Salon Pro</div>
    <div class="spacer"></div>
    <button class="btn" id="btnLogout" style="display:none;">Cerrar sesión</button>
  </div>
  <div class="container">

    <!-- Login -->
    <section id="viewLogin">
      <h2>Login</h2>
      <label>Usuario</label>
      <input type="text" id="loginUser" placeholder="usuario">
      <label>Contraseña</label>
      <input type="password" id="loginPass" placeholder="contraseña">
      <button class="btn" id="btnDoLogin">Ingresar</button>
    </section>

    <!-- Menú -->
    <section id="viewMenu" class="hidden">
      <h2>Menú</h2>
      <button class="btn" id="toAgenda">Agenda</button>
      <button class="btn" id="toBilling">Cobros/Facturas</button>
      <button class="btn" id="toAnalytics">Rendimiento</button>
      <button class="btn" id="toConfig">Configuración</button>
    </section>

    <!-- Agenda -->
    <section id="viewAgenda" class="hidden">
      <button class="btn" data-back>← Regresar al menú</button>
      <h2>Agenda</h2>
      <!-- contenido de citas simplificado -->
      <div>
        <label>Fecha:</label><input type="date" id="apDate">
        <label>Hora:</label><input type="time" id="apTime">
        <label>Cliente:</label><input type="text" id="apClient">
        <label>Técnica:</label><select id="apTech"></select>
        <button class="btn" id="btnSaveAp">Guardar cita</button>
      </div>
      <table id="tblAp">
        <thead><tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Técnica</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Cobros / Facturas -->
    <section id="viewBilling" class="hidden">
      <button class="btn" data-back>← Regresar al menú</button>
      <h2>Cobros / Facturas</h2>
      <div>
        <label>Fecha:</label><input type="date" id="invDate">
        <label>Hora:</label><input type="time" id="invTime">
        <label>Cliente:</label><input type="text" id="invClient">
        <label>Técnica:</label><select id="invTech"></select>
        <label>Método de pago:</label><select id="invPay"><option>Cash</option><option>Tarjeta</option></select>
        <label>Monto:</label><input type="number" id="invAmount" step="0.01">
        <button class="btn" id="btnSaveInv">Guardar</button>
      </div>
      <div>
        <label>Filtrar técnica:</label>
        <select id="invTechFilter"><option value="(todas)">(todas)</option></select>
        <label>Periodo:</label>
        <select id="invPeriodFilter"><option value="all">Todo</option><option value="today">Hoy</option><option value="this_month">Este mes</option><option value="this_year">Este año</option></select>
        <button class="btn" id="btnTechCSV">CSV Técnica</button>
        <button class="btn" id="btnTechPDF">PDF Técnica</button>
      </div>
      <table id="tblInv">
        <thead><tr><th>#</th><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Técnica</th><th>Monto</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Rendimiento -->
    <section id="viewAnalytics" class="hidden">
      <button class="btn" data-back>← Regresar al menú</button>
      <h2>Rendimiento</h2>
      <div>
        <label>Rango:</label>
        <select id="rangeKPI"><option value="day">Diario</option><option value="month" selected>Mensual</option><option value="year">Anual</option></select>
        <button class="btn" id="btnExportAnal">Exportar PDF</button>
      </div>
      <div id="analyticsContent">Aquí van las estadísticas...</div>
    </section>

    <!-- Configuración -->
    <section id="viewConfig" class="hidden">
      <button class="btn" data-back>← Regresar al menú</button>
      <h2>Configuración</h2>
      <div>
        <label>Nombre del Salón:</label><input type="text" id="cfgSalonName">
        <label>Prefijo de factura:</label><input type="text" id="invPrefix">
        <label>Próximo número factura:</label><input type="number" id="invNext">
      </div>
    </section>

  </div>

<script>
// Estado mínimo
const S = {
  key:k=>`salon.${k}`,
  load:(k,def)=>{ try{ return JSON.parse(localStorage.getItem(S.key(k))) ?? def } catch(e){ return def; } },
  save:(k,v)=>localStorage.setItem(S.key(k), JSON.stringify(v)),
  uid:()=>Math.random().toString(36).substr(2,9),
  today:()=>new Date().toISOString().slice(0,10)
};

const state = {
  session: S.load('session', null),
  users: S.load('users', [
    {user:'admin', pass:'admin', role:'admin'},
    {user:'user', pass:'user', role:'user'}
  ]),
  techs: S.load('techs',['General']),
  appointments: S.load('appointments',[]),
  invoices: S.load('invoices',[]),
  cfg: S.load('cfg', {
    salonName:'Salon Pro',
    invoice:{ prefix:'INV-', next:1 }
  })
};

function persistAll(){
  S.save('session', state.session);
  S.save('techs', state.techs);
  S.save('appointments', state.appointments);
  S.save('invoices', state.invoices);
  S.save('cfg', state.cfg);
}

// Manejo de vistas
const views = {
  login: document.getElementById('viewLogin'),
  menu: document.getElementById('viewMenu'),
  agenda: document.getElementById('viewAgenda'),
  billing: document.getElementById('viewBilling'),
  analytics: document.getElementById('viewAnalytics'),
  config: document.getElementById('viewConfig')
};

function showView(name){
  for(let key in views){
    views[key].classList.add('hidden');
  }
  views[name].classList.remove('hidden');

  // Mostrar logout si sesión existe
  document.getElementById('btnLogout').style.display = state.session ? 'inline-block' : 'none';
}

// Login
document.getElementById('btnDoLogin').onclick = ()=>{
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  const found = state.users.find(x=> x.user===u && x.pass===p);
  if(found){
    state.session = { user: found.user, role: found.role };
    persistAll();
    alert('Ingreso exitoso');
    loadInitial(); // ir al menú
  } else {
    alert('Usuario o contraseña incorrectos');
  }
};

// Logout
document.getElementById('btnLogout').onclick = ()=>{
  state.session = null;
  persistAll();
  showView('login');
};

// Botones del menú para cambiar sección
document.getElementById('toAgenda').onclick = ()=> { showView('agenda'); }
document.getElementById('toBilling').onclick = ()=> { showView('billing'); }
document.getElementById('toAnalytics').onclick = ()=> { showView('analytics'); }
document.getElementById('toConfig').onclick = ()=> { showView('config'); }

// Botón de “volver atrás”
document.querySelectorAll('button[data-back]').forEach(b=>{
  b.onclick = ()=> showView('menu');
});

// Inicializar datos técnicos / filtros
function refreshTechs(){
  const selAp = document.getElementById('apTech');
  const selInv = document.getElementById('invTech');
  const selFilter = document.getElementById('invTechFilter');
  if(selAp){
    selAp.innerHTML = state.techs.map(t=> `<option>${t}</option>`).join('');
  }
  if(selInv){
    selInv.innerHTML = state.techs.map(t=> `<option>${t}</option>`).join('');
    // añadir opción todas
    const html = ['(todas)', ...state.techs].map(t=> `<option value="${t}">${t}</option>`).join('');
    selFilter.innerHTML = html;
  }
}

// Agenda: guardar cita
document.getElementById('btnSaveAp').onclick = ()=>{
  const date = document.getElementById('apDate').value;
  const time = document.getElementById('apTime').value;
  const client = document.getElementById('apClient').value.trim();
  const tech = document.getElementById('apTech').value;
  if(!date || !time || !client){
    alert('Completa todos los campos de cita');
    return;
  }
  state.appointments.push({ id: S.uid(), date, time, client, tech });
  persistAll();
  renderAp();
};

// Render agenda
function renderAp(){
  const tbody = document.querySelector('#tblAp tbody');
  if(!tbody) return;
  tbody.innerHTML = state.appointments.map(a=>`
    <tr>
      <td>${a.date}</td><td>${a.time}</td><td>${a.client}</td><td>${a.tech}</td>
    </tr>
  `).join('');
}

// Cobros: guardar factura
document.getElementById('btnSaveInv').onclick = ()=>{
  const date = document.getElementById('invDate').value;
  const time = document.getElementById('invTime').value;
  const client = document.getElementById('invClient').value.trim();
  const tech = document.getElementById('invTech').value;
  const amount = parseFloat(document.getElementById('invAmount').value) || 0;
  if(!date || !time || !client || !tech || amount <=0){
    alert('Completa todos los campos de factura');
    return;
  }
  const num = `${state.cfg.invoice.prefix}${String(state.cfg.invoice.next).padStart(4,'0')}`;
  state.invoices.push({ id: S.uid(), number: num, date, time, client, tech, amount });
  state.cfg.invoice.next++;
  persistAll();
  renderInv();
};

// Render facturas
function renderInv(){
  const tbody = document.querySelector('#tblInv tbody');
  if(!tbody) return;
  tbody.innerHTML = state.invoices.map(i=>`
    <tr>
      <td>${i.number}</td><td>${i.date}</td><td>${i.time}</td><td>${i.client}</td><td>${i.tech}</td><td>$${i.amount.toFixed(2)}</td>
    </tr>
  `).join('');
}

// Export por técnica seleccionada (CSV mínimo)
document.getElementById('btnTechCSV').onclick = ()=>{
  const tech = document.getElementById('invTechFilter').value;
  let list = state.invoices.slice();
  if(tech && tech !== '(todas)'){
    list = list.filter(i=> i.tech === tech);
  }
  const rows = [['Número','Fecha','Hora','Cliente','Técnica','Monto'], ... list.map(i=>[i.number, i.date, i.time, i.client, i.tech, i.amount.toFixed(2)])];
  const csv = rows.map(r=> r.map(x=> `"${x}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type:'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `cobros_${tech}_${Date.now()}.csv`;
  a.click();
};

// Export técnico – PDF (versión simple que abre impresión)
document.getElementById('btnTechPDF').onclick = ()=>{
  const tech = document.getElementById('invTechFilter').value;
  let list = state.invoices.slice();
  if(tech && tech !== '(todas)'){
    list = list.filter(i=> i.tech === tech);
  }
  const rowsHtml = list.map(i=>`
    <tr>
      <td>${i.number}</td><td>${i.date}</td><td>${i.time}</td><td>${i.client}</td><td>${i.tech}</td><td>$${i.amount.toFixed(2)}</td>
    </tr>
  `).join('');
  const html = `
    <html><head><meta charset="utf-8"><title>Cobros Técnica ${tech}</title>
    <style> table{width:100%; border-collapse:collapse;} th,td{border:1px solid #444;padding:6px;} th{background:#333;} </style>
    </head><body>
      <h2>Cobros — Técnica ${tech}</h2>
      <table><thead><tr><th>Número</th><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Técnica</th><th>Monto</th></tr></thead>
      <tbody>${rowsHtml}</tbody></table>
    </body></html>
  `;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
};

// Inicialización al cargar
function loadInitial(){
  if(state.session){
    document.getElementById('salonName').textContent = state.cfg.salonName;
    refreshTechs();
    renderAp();
    renderInv();
    showView('menu');
  } else {
    showView('login');
  }
}

window.onload = ()=>{
  loadInitial();
};

</script>
</body>
</html>
