<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Salon Pro ‚Äî Dashboard</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">
<style>
/* ====== CSS Base / Theming ====== */
:root{
  --bg:#0f0f12;
  --fg:#ffffff;
  --muted:#a7a7b1;
  --primary:#6ee7b7;
  --topbar:#15151b;
  --card:#1a1b23;
  --btn:#26283a;
  --accent:#93c5fd;
  --danger:#ef4444;
  --ok:#22c55e;
  --warn:#f59e0b;
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";

  /* ===== Estilo de Men√∫ ===== */
  --menu-radius:16px;
  --menu-blur:10px;
  --menu-shadow:0 10px 30px rgba(0,0,0,.35);
  --menu-card:rgba(255,255,255,.04);
  --menu-border:1px solid rgba(255,255,255,.10);
  --menu-cols:2;
  --menu-icon:22px;
}
*{box-sizing:border-box;}
html,body{height:100%;}
body{
  margin:0;
  background:var(--bg) no-repeat center/cover;
  color:var(--fg);
  font-family:var(--font);
}
.topbar{
  position:sticky;
  top:0; z-index:10;
  display:flex;
  align-items:center;
  gap:.6rem;
  padding:.6rem .9rem;
  background:var(--topbar);
  border-bottom:1px solid #00000055;
}
.logo{ width:34px;height:34px;border-radius:6px;object-fit:contain;background:#0003;display:inline-block;}
.title{font-weight:700;letter-spacing:.2px;}
.spacer{flex:1;}
.btn{
  display:inline-flex;align-items:center;gap:.5rem;
  padding:.55rem .8rem;border-radius:10px;
  border:1px solid #00000066;
  background:var(--btn);color:var(--fg);
  cursor:pointer;font-weight:600;
}
.btn.small{padding:.35rem .6rem;font-size:.9rem;border-radius:8px;}
.btn.ghost{background:transparent;}
.btn.primary{background:var(--accent);}
.btn.ok{background:var(--ok);}
.btn.warn{background:var(--warn);}
.btn.danger{background:var(--danger);}
.hidden{display:none !important;}
.container{max-width:1000px;margin:1rem auto;padding:0 1rem;}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;padding:1rem;margin:.7rem 0;
  box-shadow:0 12px 28px rgba(0,0,0,.28);
}
.grid{display:grid;gap:1rem;}
.grid.two{grid-template-columns:repeat(2,minmax(0,1fr));}
.grid.three{grid-template-columns:repeat(3,minmax(0,1fr));}
label{display:block;margin:.4rem 0 .2rem;color:var(--muted);font-size:.9rem;}
input,select,textarea{
  width:100%;padding:.55rem .6rem;border-radius:10px;
  border:1px solid #00000055;background:#0f1017;color:var(--fg);
}
input[type="color"]{padding:.2rem;height:38px;}
.row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;}
.kbd{background:#0002;border:1px solid #0003;border-radius:6px;padding:.1rem .35rem;font-size:.85rem;}

table{width:100%;border-collapse:collapse;}
th,td{padding:.55rem;border-bottom:1px solid #00000055;}
th{color:var(--muted);text-align:left;}

hr{border:none;border-top:1px solid #00000055;margin:1rem 0;}
footer{opacity:.8;text-align:center;padding:2rem 0;}

@media print{
  body{background:#fff;color:#000;}
  .topbar,.btn,.no-print{display:none !important;}
  .card{border:1px solid #ddd;}
}
</style>
</head>
<body>
  <!-- ===== Topbar ===== -->
  <div class="topbar no-print">
    <img id="logoTop" class="logo" alt="logo">
    <div class="title" id="salonName">Mi Sal√≥n</div>
    <span class="spacer"></span>
    <button class="btn small" id="btnDashboard">üè† Men√∫</button>
    <button class="btn small" id="btnLogout" title="Cerrar sesi√≥n">üîì Salir</button>
  </div>

  <div class="container">
    <!-- ===== Login ===== -->
    <section id="viewLogin" class="login-wrap">
      <div class="card" style="min-width:320px;max-width:420px">
        <div class="brand-preview">
          <img id="logoLogin" class="logo" alt="logo">
          <div>
            <div style="font-weight:800" id="salonNameLogin">Mi Sal√≥n</div>
            <small style="opacity:.7">Acceso</small>
          </div>
        </div>
        <hr>
        <label>Usuario</label><input id="loginUser" placeholder="usuario">
        <label>Contrase√±a</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <div class="row" style="margin-top:.7rem">
          <button class="btn ok" id="btnDoLogin">Ingresar</button>
          <span class="kbd">Admin demo: admin / admin</span>
          <span class="kbd">Usuario demo: user / user</span>
        </div>
      </div>
    </section>

    <!-- ===== Men√∫ principal ===== -->
    <section id="viewMenu" class="hidden">
      <div class="row">
        <div class="card" style="flex:1">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h2 style="margin:.2rem 0">Men√∫</h2>
            <span class="badge">Arrastra para reordenar</span>
          </div>
          <div id="menuList" class="menu no-print"></div>
        </div>
      </div>
    </section>

    <!-- ===== Agenda ===== -->
    <section id="viewAgenda" class="hidden">
      <div class="row"><button class="btn ghost" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="grid two">
        <div class="card">
          <h3>Crear / Editar cita</h3>
          <div class="grid two">
            <div><label>Fecha</label><input type="date" id="apDate"></div>
            <div><label>Hora</label><input type="time" id="apTime"></div>
            <div><label>Cliente</label><input id="apClient" placeholder="Nombre y Apellido"></div>
            <div><label>Tel√©fono</label><input id="apPhone" placeholder="+1..."></div>
            <div><label>Servicio</label><input id="apService" list="servicesList" placeholder="Corte, Color..."></div>
            <div><label>T√©cnica</label><select id="apTech"></select></div>
          </div>
          <div class="row" style="margin-top:.6rem">
            <button class="btn ok" id="btnSaveAp">üíæ Guardar</button>
            <button class="btn warn" id="btnResched" title="Reagendar seleccionada">üîÑ Reagendar</button>
            <button class="btn danger" id="btnNoShow">üö´ No-show</button>
            <button class="btn" id="btnGCal">üìÖ Google Calendar</button>
            <button class="btn" id="btnWhats">üü¢ WhatsApp</button>
          </div>
          <small class="muted">Bloquea duplicados: misma persona + hora + d√≠a + t√©cnica.</small>
        </div>
        <div class="card">
          <h3>Calendario & Disponibilidad</h3>
          <div class="row">
            <input type="month" id="calMonth">
            <input type="date" id="filterDate">
            <input placeholder="Buscar por cliente" id="filterClient">
          </div>
          <div id="calendar" class="calendar" style="margin-top:.6rem"></div>
          <h4>Slots disponibles</h4>
          <div id="slots" class="scroll"></div>
        </div>
      </div>

      <div class="card">
        <h3>Citas (hoy y futuras)</h3>
        <div class="row">
          <button class="btn small" id="btnExportApPDF">üñ®Ô∏è PDF</button>
          <button class="btn small" id="btnExportApCSV">üìÑ Excel (CSV)</button>
          <button class="btn small" id="btnExportApJSON">üíæ Exportar JSON</button>
          <input type="file" id="importApJSON" class="no-print" accept="application/json">
        </div>
        <table id="tblAp"></table>
      </div>
    </section>

    <!-- ===== Cobros / Facturas ===== -->
    <section id="viewBilling" class="hidden">
      <div class="row"><button class="btn ghost" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="grid two">
        <div class="card">
          <h3>Nuevo cobro / factura</h3>
          <div class="grid two">
            <div><label>Fecha</label><input type="date" id="invDate"></div>
            <div><label>Hora</label><input type="time" id="invTime"></div>
            <div><label>Cliente</label><input id="invClient"></div>
            <div><label>Tel√©fono</label><input id="invPhone"></div>
            <div><label>Servicio</label><input id="invService" list="servicesList"></div>
            <div><label>T√©cnica</label><select id="invTech"></select></div>
            <div><label>M√©todo de pago</label><select id="invPay"><option>ATH M√≥vil</option><option>Cash</option><option>Tarjeta</option></select></div>
            <div><label>Monto</label><input id="invAmount" type="number" step="0.01"></div>
          </div>
          <div class="row" style="margin-top:.6rem">
            <button class="btn ok" id="btnSaveInv">üíæ Guardar & Enviar a Hoja</button>
            <button class="btn" id="btnInvoicePDF">üñ®Ô∏è PDF</button>
          </div>
        </div>

        <div class="card">
          <h3>Historial de cobros</h3>
          <div class="row">
            <button class="btn small" id="btnExportInvPDF">üñ®Ô∏è PDF</button>
            <button class="btn small" id="btnExportInvJSON">üíæ JSON</button>
            <button class="btn small" id="btnExportInvCSV">üìÑ CSV</button>
            <input type="file" id="importInvJSON" class="no-print" accept="application/json">

            <label for="invTechFilter">T√©cnica</label>
            <select id="invTechFilter" title="Filtrar por t√©cnica"></select>

            <label for="invPeriodFilter">Periodo</label>
            <select id="invPeriodFilter" title="Filtrar por periodo">
              <option value="all">Todo</option>
              <option value="today">Hoy</option>
              <option value="this_month">Este mes</option>
              <option value="this_year">Este a√±o</option>
            </select>

            <button class="btn small" id="btnTechDayPDF">üñ®Ô∏è PDF D√≠a (T√©cnica)</button>
            <button class="btn small" id="btnTechDayCSV">üìÑ Excel D√≠a (T√©cnica)</button>

            <button class="btn small" id="btnTechHourPDF">üñ®Ô∏è PDF Hora (T√©cnica)</button>
            <button class="btn small" id="btnTechHourCSV">üìÑ Excel Hora (T√©cnica)</button>

            <button class="btn small" id="btnTechMonthPDF">üñ®Ô∏è PDF Mes (T√©cnica)</button>
            <button class="btn small" id="btnTechMonthCSV">üìÑ Excel Mes (T√©cnica)</button>

            <button class="btn small" id="btnTechYearPDF">üñ®Ô∏è PDF A√±o (T√©cnica)</button>
            <button class="btn small" id="btnTechYearCSV">üìÑ Excel A√±o (T√©cnica)</button>
          </div>
          <table id="tblInv">
            <thead><tr><th>#</th><th>Fecha</th><th>Hora</th><th>Cliente</th><th>T√©cnica</th><th>M√©todo</th><th>Monto</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== Rendimiento / Analytics ===== -->
    <section id="viewAnalytics" class="hidden">
      <div class="row"><button class="btn ghost" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="card">
        <h3>Indicadores</h3>
        <div class="row">
          <select id="rangeKPI">
            <option value="day">Diario</option>
            <option value="week">Semanal</option>
            <option value="month" selected>Mensual</option>
          </select>
          <button class="btn small" id="btnExportAnalPDF">üñ®Ô∏è PDF</button>
        </div>
        <div id="kpis" class="grid three"></div>
      </div>
      <div class="card">
        <h3>Gr√°ficas</h3>
        <canvas id="chart1" height="160"></canvas>
        <canvas id="chart2" height="160" style="margin-top:1rem"></canvas>
      </div>
      <div class="card">
        <h3>Historial</h3>
        <div class="row">
          <button class="btn small" id="btnExportLogsPDF">üñ®Ô∏è PDF</button>
        </div>
        <table id="tblLogs"></table>
      </div>
    </section>

    <!-- ===== Configuraci√≥n ===== -->
    <section id="viewConfig" class="hidden">
      <div class="row"><button class="btn ghost" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="grid two">
        <div class="card">
          <h3>Branding & Estilo</h3>
          <div class="grid two">
            <div><label>Nombre del sal√≥n</label><input id="cfgSalonName" placeholder="Mi Sal√≥n"></div>
            <div><label>Fuente</label><input id="cfgFont" placeholder="Inter, system-ui"></div>
            <div><label>Color fondo</label><input type="color" id="cfgBg"></div>
            <div><label>Color topbar</label><input type="color" id="cfgTopbar"></div>
            <div><label>Color botones</label><input type="color" id="cfgBtn"></div>
            <div><label>Color acento</label><input type="color" id="cfgAccent"></div>
          </div>
          <label>Imagen de fondo (PNG transparente opcional)</label>
          <input type="file" id="cfgBgImg" accept="image/*">
          <label>Logo</label>
          <input type="file" id="cfgLogo" accept="image/*">
          <label>Footer</label><input id="cfgFooter" placeholder="¬© Mi Sal√≥n">

          <hr>
          <h3>Datos del negocio</h3>
          <div class="grid two">
            <div><label>Nombre comercial</label><input id="bizName" placeholder="Mi Negocio"></div>
            <div><label>RNC / Tax ID</label><input id="bizTax" placeholder="RNC"></div>
            <div><label>Tel√©fono</label><input id="bizPhone" placeholder="+1 787 ..."></div>
            <div><label>Email</label><input id="bizEmail" placeholder="hola@tu-negocio.com"></div>
            <div><label>Direcci√≥n</label><input id="bizAddress" placeholder="Calle, ciudad, pa√≠s"></div>
            <div><label>Website</label><input id="bizWeb" placeholder="https://..."></div>
          </div>

          <hr>
          <h3>Facturaci√≥n</h3>
          <div class="grid two">
            <div><label>Prefijo factura</label><input id="invPrefix" placeholder="INV-"></div>
            <div><label>Pr√≥ximo n√∫mero</label><input id="invNext" type="number" min="1"></div>
            <div class="grid two" style="grid-column:1/-1">
              <div><label>T√≠tulo de recibo</label><input id="invTitle" placeholder="Factura / Recibo"></div>
              <div><label>Pie de p√°gina</label><input id="invFooter" placeholder="Gracias por su preferencia."></div>
            </div>
          </div>

          <hr>
          <h3>Horario de servicio</h3>
          <table id="tblHours"></table>

          <hr>
          <h3>Servicios & Precios</h3>
          <div class="row">
            <input id="srvName" placeholder="Servicio">
            <input id="srvPrice" type="number" step="0.01" placeholder="Precio">
            <button class="btn small" id="btnAddSrv">Agregar</button>
          </div>
          <table id="tblSrv"></table>

          <hr>
          <h3>T√©cnicas / Estilistas</h3>
          <div class="row">
            <input id="techNew" placeholder="Agregar t√©cnica...">
            <button class="btn small" id="btnAddTech">Agregar</button>
          </div>
          <ul id="techList"></ul>

          <hr>
          <h3>Orden del men√∫ (drag & drop)</h3>
          <div id="menuOrder" class="menu"></div>
        </div>
      </div>
    </section>

    <!-- ===== Backups ===== -->
    <section id="viewBackups" class="hidden">
      <div class="row"><button class="btn ghost" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="card">
        <h3>Backups & restauraci√≥n</h3>
        <div class="grid two">
          <div>
            <h4>Citas</h4>
            <div class="row">
              <button class="btn small" data-backup="appointments:daily">Diario</button>
              <button class="btn small" data-backup="appointments:weekly">Semanal</button>
              <button class="btn small" data-backup="appointments:monthly">Mensual</button>
              <button class="btn small" data-backup="appointments:yearly">Anual</button>
            </div>
          </div>
          <div>
            <h4>Cobros & No-shows</h4>
            <div class="row">
              <button class="btn small" data-backup="billing:daily">Diario</button>
              <button class="btn small" data-backup="billing:weekly">Semanal</button>
              <button class="btn small" data-backup="billing:monthly">Mensual</button>
              <button class="btn small" data-backup="billing:yearly">Anual</button>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:.6rem">
          <button class="btn" id="btnSchedBackups">Programar frecuencias</button>
          <button class="btn" id="btnExportAll">Exportar TODO (ZIP-like JSON)</button>
          <input type="file" id="importAll" accept="application/json">
        </div>
      </div>
    </section>

    <!-- ===== Footer ===== -->
    <footer id="appFooter" class="no-print">¬© Mi Sal√≥n</footer>
  </div>

<script>
// ===== Utilidades & Estado =====
const S = {
  key:k=>`salon.${k}`,
  load:(k,def)=>{ try{ return JSON.parse(localStorage.getItem(S.key(k))) ?? def } catch{return def} },
  save:(k,v)=>localStorage.setItem(S.key(k), JSON.stringify(v)),
  uid:()=>Math.random().toString(36).slice(2),
  today:()=>new Date().toISOString().slice(0,10),
  nowTime:()=>new Date().toTimeString().slice(0,5),
  pad:n=>n.toString().padStart(2,'0'),
  csv:(rows)=> rows.map(r=> r.map(x=> `"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n'),
  download:(name,content,type='application/json')=>{
    const a=document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content],{type}));
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  },
  notify:(msg)=>{ alert(msg); console.log(msg); }
};

const state = {
  session: S.load('session', null),
  cfg: S.load('cfg', {
    salonName:'Mi Sal√≥n',
    font:'Inter, system-ui',
    colors:{bg:'#0f0f12',topbar:'#15151b',btn:'#26283a',accent:'#93c5fd'},
    footer:'¬© Mi Sal√≥n',
    logo:null, bgImage:null,
    business:{ name:'Mi Sal√≥n', taxId:'', phone:'', email:'', address:'', website:'' },
    invoice:{ prefix:'INV-', next:1, title:'Factura / Recibo', footer:'Gracias por su preferencia.' },
    menuStyle:{ radius:16, blur:10, shadow:.35, cols:2, card:'rgba(255,255,255,.04)', border:'1px solid rgba(255,255,255,.10)', icon:22, layout:'grid' },
    hours:{
      sun:{open:false,from:"00:00",to:"00:00"},
      mon:{open:true ,from:"09:00",to:"18:00"},
      tue:{open:true ,from:"09:00",to:"18:00"},
      wed:{open:true ,from:"09:00",to:"18:00"},
      thu:{open:true ,from:"09:00",to:"18:00"},
      fri:{open:true ,from:"09:00",to:"18:00"},
      sat:{open:true ,from:"09:00",to:"14:00"}
    },
    apptStepMinutes:30
  }),
  users: S.load('users', [
    {user:'admin',pass:'admin',role:'admin'},
    {user:'user',pass:'user',role:'user'}
  ]),
  menu: S.load('menu', [
    {id:'Agenda', ico:'üìÖ', view:'viewAgenda', role:'user'},
    {id:'Cobros/Facturas', ico:'üí≥', view:'viewBilling', role:'user'},
    {id:'Rendimiento', ico:'üìà', view:'viewAnalytics', role:'admin'},
    {id:'Configuraci√≥n', ico:'‚öôÔ∏è', view:'viewConfig', role:'admin'},
    {id:'Backups', ico:'üóÇÔ∏è', view:'viewBackups', role:'admin'}
  ]),
  techs: S.load('techs',['General']),
  services: S.load('services',[
    {name:'Corte', price:25},{name:'Color', price:60},{name:'Blowout', price:30}
  ]),
  appointments: S.load('appointments',[]),
  invoices: S.load('invoices',[]),
  noshows: S.load('noshows',[]),
  logs: S.load('logs',[]),
  lastInvId: S.load('lastInvId', null),
  chartMode: S.load('chartMode','tech')
};

function persistAll(){
  ['session','cfg','users','menu','techs','services','appointments','invoices','noshows','logs','lastInvId','chartMode'].forEach(k=>S.save(k, state[k]));
}

// ===== Theming / Branding =====
function applyTheme(){
  document.documentElement.style.setProperty('--bg', state.cfg.colors.bg);
  document.documentElement.style.setProperty('--topbar', state.cfg.colors.topbar);
  document.documentElement.style.setProperty('--btn', state.cfg.colors.btn);
  document.documentElement.style.setProperty('--accent', state.cfg.colors.accent);
  document.body.style.fontFamily = state.cfg.font;

  const ms = state.cfg.menuStyle;
  document.documentElement.style.setProperty('--menu-radius', ms.radius+'px');
  document.documentElement.style.setProperty('--menu-blur', ms.blur+'px');
  document.documentElement.style.setProperty('--menu-shadow', `0 10px 30px rgba(0,0,0,${ms.shadow})`);
  document.documentElement.style.setProperty('--menu-card', ms.card);
  document.documentElement.style.setProperty('--menu-border', ms.border);
  document.documentElement.style.setProperty('--menu-icon', ms.icon+'px');

  document.body.classList.remove('sidebar-left','sidebar-right');
  const menuEl = document.getElementById('menuList');
  menuEl.classList.remove('list','sidebar');
  if(ms.layout==='list'){ menuEl.classList.add('list'); }
  if(ms.layout==='sidebar-left' || ms.layout==='sidebar-right'){
    menuEl.classList.add('sidebar');
    document.body.classList.add(ms.layout==='sidebar-left'?'sidebar-left':'sidebar-right');
  }

  const footer = document.getElementById('appFooter');
  if(footer) footer.textContent = state.cfg.footer || '';

  const brand = state.cfg.business?.name || state.cfg.salonName;
  const elSalon = document.getElementById('salonName');
  if(elSalon) elSalon.textContent = brand;
  const elLogin = document.getElementById('salonNameLogin');
  if(elLogin) elLogin.textContent = brand;

  if(state.cfg.bgImage) document.body.style.backgroundImage = `url(${state.cfg.bgImage})`;
    else document.body.style.backgroundImage='none';

  const logos = document.querySelectorAll('#logoTop,#logoLogin');
  logos.forEach(el=>{
    if(state.cfg.logo) el.src = state.cfg.logo;
    else el.removeAttribute('src');
  });
}

// ===== Router simple =====
const views = ['viewLogin','viewMenu','viewAgenda','viewBilling','viewAnalytics','viewConfig','viewBackups'];
function show(view){
  views.forEach(v=>document.getElementById(v).classList.add('hidden'));
  document.getElementById(view).classList.remove('hidden');
}
function toMenu(){
  buildMenu();
  show('viewMenu');
}

// ===== Login & permisos =====
function login(u,p){
  const found = state.users.find(x=>x.user===u && x.pass===p);
  if(!found) return S.notify('Usuario o contrase√±a incorrectos');
  state.session = {user:found.user, role:found.role, ts:Date.now()};
  S.save('session', state.session);
  log('login',`${found.user}`);
  applyRoleVisibility();
  toMenu();
}
function logout(){
  state.session = null;
  S.save('session', null);
  show('viewLogin');
}
function applyRoleVisibility(){
  const role = state.session?.role || 'user';
  const restricted = ['viewAnalytics','viewConfig','viewBackups'];
  const current = views.find(v=>!document.getElementById(v).classList.contains('hidden'));
  if(role!=='admin' && restricted.includes(current)) toMenu();
}

// ===== Men√∫ con drag & drop =====
function buildMenu(){
  const ml = document.getElementById('menuList');
  if(!ml) return;
  ml.innerHTML = '';
  const role = state.session?.role || 'user';
  state.menu.filter(m=>role==='admin' || m.role!=='admin').forEach(m=>{
    const el = document.createElement('div');
    el.className='item';
    el.draggable=true;
    el.dataset.view = m.view;
    el.innerHTML = `<div class="ico">${m.ico}</div><div style="font-weight:700">${m.id}</div><div class="tag">${m.view}</div>`;
    el.addEventListener('click', ()=>{
      show(m.view);
      if(m.view==='viewAgenda') renderAgenda();
      if(m.view==='viewBilling') renderBilling();
      if(m.view==='viewAnalytics') renderAnalytics();
      if(m.view==='viewConfig') renderConfig();
      if(m.view==='viewBackups') renderBackups();
      applyRoleVisibility();
    });
    ml.appendChild(el);
  });
  const mo = document.getElementById('menuOrder');
  if(mo){
    mo.innerHTML = '';
    state.menu.forEach((m,i)=>{
      const li = document.createElement('div');
      li.className='item';
      li.draggable=true;
      li.dataset.view = m.view;
      li.innerHTML = `<div class="ico">${m.ico}</div><div>${m.id}</div>`;
      li.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', m.view));
      li.addEventListener('dragover', e=> e.preventDefault());
      li.addEventListener('drop', e=>{
        e.preventDefault();
        const v = e.dataTransfer.getData('text/plain');
        const from = state.menu.findIndex(x=>x.view===v);
        const to = state.menu.findIndex(x=>x.view===m.view);
        const [moved] = state.menu.splice(from,1);
        state.menu.splice(to,0,moved);
        persistAll();
        buildMenu();
      });
      mo.appendChild(li);
    });
  }
}

// ===== Servicios / T√©cnicas =====
function refreshTechs(){
  const selAp = document.getElementById('apTech');
  const selInv = document.getElementById('invTech');
  const selFilter = document.getElementById('invTechFilter');
  if(selAp){
    selAp.innerHTML = state.techs.map(t=>`<option>${t}</option>`).join('');
  }
  if(selInv){
    selInv.innerHTML = state.techs.map(t=>`<option>${t}</option>`).join('');
  }
  if(selFilter){
    const opts = ['(todas)', ...state.techs];
    selFilter.innerHTML = opts.map(t=>`<option value="${t}">${t}</option>`).join('');
  }

  const ul = document.getElementById('techList');
  if(ul){
    ul.innerHTML = '';
    state.techs.forEach((t,i)=>{
      const li = document.createElement('li');
      li.textContent = t + ' ';
      const b = document.createElement('button');
      b.className='btn small danger';
      b.textContent='Eliminar';
      b.onclick = ()=>{
        state.techs.splice(i,1);
        persistAll();
        refreshTechs();
      };
      li.appendChild(b);
      ul.appendChild(li);
    });
  }
}

function refreshServices(){
  const dl = document.getElementById('servicesList');
  if(dl){
    dl.innerHTML = '';
    state.services.forEach(s=>{
      const o = document.createElement('option');
      o.value = s.name;
      dl.appendChild(o);
    });
  }
  const tbl = document.getElementById('tblSrv');
  if(tbl){
    tbl.innerHTML = '<tr><th>Servicio</th><th>Precio</th><th></th></tr>' +
      state.services.map((s,i)=>`<tr><td>${s.name}</td><td>$${(+s.price).toFixed(2)}</td><td><button class="btn small" onclick="delSrv(${i})">Eliminar</button></td></tr>`).join('');
  }
}
function delSrv(i){
  state.services.splice(i,1);
  persistAll();
  refreshServices();
}

// ===== Agenda =====
function renderAgenda(){
  document.getElementById('apDate').value = S.today();
  const h = hoursFor(S.today());
  document.getElementById('apTime').value = h.open ? h.from : '10:00';
  document.getElementById('filterDate').value = S.today();
  if(!document.getElementById('btnExportApCSV')){
    const btn = document.createElement('button');
    btn.id='btnExportApCSV';
    btn.className='btn small';
    btn.textContent='üìÑ Excel (CSV)';
    document.getElementById('btnExportApPDF').after(btn);
    btn.onclick = exportAppointmentsCSV;
  }
  renderCalendar();
  renderApTable();
  renderSlots();
}

function hoursFor(dateStr){
  const d = new Date(dateStr);
  const DKEY = ['sun','mon','tue','wed','thu','fri','sat'];
  const key = DKEY[d.getDay()];
  const h = state.cfg.hours[key];
  return h || {open:true, from:'09:00', to:'18:00'};
}

function renderCalendar(){
  const cal = document.getElementById('calendar');
  if(!cal) return;
  cal.innerHTML='';
  const m = document.getElementById('calMonth').value || new Date().toISOString().slice(0,7);
  const [y,mm] = m.split('-').map(n=>+n);
  const days = new Date(y, mm, 0).getDate();
  for(let d=1; d<=days; d++){
    const date = new Date(y, mm-1, d);
    const el = document.createElement('div');
    el.className='day';
    if(S.isSameDay(date, new Date())) el.classList.add('today');
    const has = state.appointments.some(a => a.date === date.toISOString().slice(0,10));
    el.innerHTML = `<div style="font-weight:700">${d}</div><div>${has?'<span class="badge">citas</span>':''}</div>`;
    el.onclick = ()=>{
      document.getElementById('filterDate').value = date.toISOString().slice(0,10);
      renderApTable();
      renderSlots();
    };
    cal.appendChild(el);
  }
}

function isDuplicateAp({date,time,client,tech}){
  return state.appointments.some(a => a.date===date && a.time===time && a.client.trim().toLowerCase()===client.trim().toLowerCase() && a.tech===tech);
}

function renderSlots(){
  const date = document.getElementById('filterDate').value || S.today();
  const H = hoursFor(date);
  const step = Math.max(5, Math.min(120, +state.cfg.apptStepMinutes || 30));
  const slotsEl = document.getElementById('slots');
  if(!slotsEl) return;
  slotsEl.innerHTML='';
  if(!H.open){
    slotsEl.innerHTML = '<div class="badge">Cerrado</div>';
    return;
  }
  const booked = state.appointments.filter(a=>a.date===date).map(a=>a.time);
  const open = [];
  const [fh,fm] = H.from.split(':').map(Number);
  const [th,tm] = H.to.split(':').map(Number);
  const start = fh*60 + fm;
  const end = th*60 + tm;
  for(let m = start; m < end; m += step){
    const h = Math.floor(m/60);
    const mm2 = m % 60;
    const t = `${S.pad(h)}:${S.pad(mm2)}`;
    if(!booked.includes(t)){
      open.push(t);
    }
  }
  slotsEl.innerHTML = open.length
    ? open.map(t=>`<button class="btn small" onclick="apTime.value='${t}';apDate.value='${date}'">${t}</button>`).join(' ')
    : '<div class="badge">Sin disponibilidad</div>';
}

function renderApTable(){
  const d = document.getElementById('filterDate').value;
  const c = document.getElementById('filterClient').value?.toLowerCase();
  let rows = state.appointments;
  if(d) rows = rows.filter(a=>a.date===d);
  if(c) rows = rows.filter(a=>a.client.toLowerCase().includes(c));
  rows.sort((a,b)=> a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
  const tbl = document.getElementById('tblAp');
  if(!tbl) return;
  tbl.innerHTML = '<tr><th></th><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Tel√©fono</th><th>Servicio</th><th>T√©cnica</th><th>Estatus</th></tr>' +
    rows.map(a=>`<tr data-id="${a.id}">
      <td><input type="radio" name="selAp" value="${a.id}"></td>
      <td>${a.date}</td><td>${a.time}</td><td>${a.client}</td><td>${a.phone||''}</td><td>${a.service||''}</td><td>${a.tech||''}</td><td>${a.status==='no-show'?'<span class="badge">no-show</span>':'‚úÖ'}</td>
    </tr>`).join('');
}

// Export Agenda
function exportAppointmentsCSV(){
  const rows = [['Fecha','Hora','Cliente','Tel√©fono','Servicio','T√©cnica','Estatus'],
    ...state.appointments.map(a=>[a.date,a.time,a.client,a.phone||'',a.service||'',a.tech||'',a.status||'ok'])
  ];
  S.download(`citas-${Date.now()}.csv`, S.csv(rows), 'text/csv');
}
document.getElementById('btnExportApCSV')?.addEventListener('click', exportAppointmentsCSV);
document.getElementById('btnExportApPDF')?.addEventListener('click', ()=>{
  const rows = state.appointments.map(a=>`
    <tr><td>${a.date}</td><td>${a.time}</td><td>${a.client}</td><td>${a.phone||''}</td><td>${a.service||''}</td><td>${a.tech||''}</td><td>${a.status||'ok'}</td></tr>
  `).join('');
  const html = `<html><head><meta charset="utf-8"><title>Citas</title>
    <style>@page{size:A4 landscape;margin:10mm}body{font-family:${state.cfg.font};color:#111}
    table{width:100%;border-collapse:collapse;font-size:12px}th,td{border:1px solid #ccc;padding:6px}th{background:#f3f3f3}</style>
  </head><body><h1>Citas</h1><table><thead><tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Tel√©fono</th><th>Servicio</th><th>T√©cnica</th><th>Estatus</th></tr></thead><tbody>${rows}</tbody></table></body></html>`;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
});

// ===== Cobros / Facturas + export por t√©cnica =====

// Funciones auxiliares para rango de periodo
function getPeriodRange(period){
  const now = new Date();
  const startOfDay   = new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const startOfMonth = new Date(now.getFullYear(),now.getMonth(),1);
  const startOfYear  = new Date(now.getFullYear(),0,1);
  if(period==='today')      return {from:startOfDay, to:new Date(startOfDay.getFullYear(), startOfDay.getMonth(), startOfDay.getDate()+1)};
  if(period==='this_month') return {from:startOfMonth, to:new Date(now.getFullYear(), now.getMonth()+1,1)};
  if(period==='this_year')  return {from:startOfYear, to:new Date(now.getFullYear()+1,0,1)};
  return null; // 'all'
}

function groupInvoices(mode, opts={}){
  const { tech = '(todas)', period = 'all' } = opts;
  let list = state.invoices.slice();

  const pr = getPeriodRange(period);
  if(pr){
    list = list.filter(i=>{
      const d = new Date(i.date);
      return (!pr.from || d >= pr.from) && (!pr.to || d < pr.to);
    });
  }

  if(tech && tech !== '(todas)'){
    list = list.filter(i=> i.tech === tech);
  }

  const keyFn = mode==='day' ? i=> i.date
    : mode==='hour' ? i=> i.time ? i.time.slice(0,2) + ':00' : '(sin hora)'
    : mode==='month' ? i=> i.date ? i.date.slice(0,7) : '(sin mes)'
    : mode==='year' ? i=> i.date ? i.date.slice(0,4) : '(sin a√±o)'
    : i=>i.date;

  const map = {};
  list.forEach(i=>{
    const key = keyFn(i);
    const amt = +i.amount || 0;
    if(!map[key]) map[key] = { key, count:0, total:0 };
    map[key].count += 1;
    map[key].total += amt;
  });
  const arr = Object.values(map);
  arr.sort((a,b)=>{
    if(a.key < b.key) return -1;
    if(a.key > b.key) return 1;
    return 0;
  });
  return arr;
}

function exportInvGroupedCSV(mode, opts={}){
  const labels = { day:'D√≠a', hour:'Hora', month:'Mes', year:'A√±o' };
  const nice = labels[mode] || mode;
  const data = groupInvoices(mode, opts);
  const rows = [
    [nice, 'Cantidad', 'Total ($)'],
    ...data.map(r=> [r.key, r.count, r.total.toFixed(2)])
  ];
  const techpart = opts.tech && opts.tech !== '(todas)' ? `-${opts.tech.replace(/\s+/g,'_')}` : '';
  const periodpart = opts.period || 'all';
  const filename = `cobros_por_${nice}${techpart}_${periodpart}.csv`;
  S.download(filename, S.csv(rows), 'text/csv');
}

function exportInvGroupedPDF(mode, opts={}){
  const labels = { day:'D√≠a', hour:'Hora', month:'Mes', year:'A√±o' };
  const nice = labels[mode] || mode;
  const data = groupInvoices(mode, opts);
  const sumTotal = data.reduce((a,x)=> a + x.total, 0);
  const sumCount = data.reduce((a,x)=> a + x.count, 0);

  const rowsHtml = data.map(r=> `
    <tr>
      <td>${r.key}</td>
      <td style="text-align:right">${r.count}</td>
      <td style="text-align:right">$${r.total.toFixed(2)}</td>
    </tr>
  `).join('');

  const periodLabel = opts.period==='today' ? 'Hoy'
    : opts.period==='this_month' ? 'Este mes'
    : opts.period==='this_year' ? 'Este a√±o'
    : 'Todo';

  const titleExtra = opts.tech && opts.tech !== '(todas)' ? ` ‚Äî T√©cnica: ${opts.tech}` : '';

  const html = `
    <html><head><meta charset="utf-8"><title>Cobros por ${nice}${titleExtra}</title>
      <style>
        @page{ size:A4 landscape; margin:12mm }
        body{ font-family:Arial, sans-serif; color:#111; }
        h1{ margin-bottom:8px; }
        .meta{ margin-bottom:12px; color:#555; }
        table{ width:100%; border-collapse:collapse; font-size:12px; }
        th,td{ border:1px solid #ccc; padding:6px; }
        th{ background:#f3f3f3; text-align:left; }
        tfoot td{ font-weight:700; background:#fafafa; }
      </style>
    </head><body>
      <h1>Historial de Cobros ‚Äî Agrupado por ${nice}${titleExtra}</h1>
      <div class="meta">Periodo: ${periodLabel} ¬∑ Generado: ${new Date().toLocaleString()}</div>
      <table>
        <thead><tr><th>${nice}</th><th style="text-align:right">Cantidad</th><th style="text-align:right">Total ($)</th></tr></thead>
        <tbody>${rowsHtml}</tbody>
        <tfoot><tr><td>TOTAL</td><td style="text-align:right">${sumCount}</td><td style="text-align:right">$${sumTotal.toFixed(2)}</td></tr></tfoot>
      </table>
    </body></html>
  `;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

// ===== Botones export by t√©cnica =====
function currentTechFilter(){
  const sel = document.getElementById('invTechFilter');
  return sel ? sel.value : '(todas)';
}
function currentPeriodFilter(){
  const sel = document.getElementById('invPeriodFilter');
  return sel ? sel.value : 'all';
}

function wireTechExportButtons(){
  document.getElementById('btnTechDayCSV').onclick   = ()=> exportInvGroupedCSV('day'  , { tech: currentTechFilter(), period: currentPeriodFilter() });
  document.getElementById('btnTechDayPDF').onclick   = ()=> exportInvGroupedPDF('day'  , { tech: currentTechFilter(), period: currentPeriodFilter() });

  document.getElementById('btnTechHourCSV').onclick  = ()=> exportInvGroupedCSV('hour' , { tech: currentTechFilter(), period: currentPeriodFilter() });
  document.getElementById('btnTechHourPDF').onclick  = ()=> exportInvGroupedPDF('hour' , { tech: currentTechFilter(), period: currentPeriodFilter() });

  document.getElementById('btnTechMonthCSV').onclick = ()=> exportInvGroupedCSV('month', { tech: currentTechFilter(), period: currentPeriodFilter() });
  document.getElementById('btnTechMonthPDF').onclick = ()=> exportInvGroupedPDF('month', { tech: currentTechFilter(), period: currentPeriodFilter() });

  document.getElementById('btnTechYearCSV').onclick  = ()=> exportInvGroupedCSV('year' , { tech: currentTechFilter(), period: currentPeriodFilter() });
  document.getElementById('btnTechYearPDF').onclick  = ()=> exportInvGroupedPDF('year' , { tech: currentTechFilter(), period: currentPeriodFilter() });
}

// ===== Guardar factura individual =====
document.getElementById('btnSaveInv').onclick = ()=>{
  const num = `${state.cfg.invoice.prefix}${String(state.cfg.invoice.next).padStart(5,'0')}`;
  const inv = {
    id: S.uid(),
    number: num,
    date: document.getElementById('invDate').value,
    time: document.getElementById('invTime').value,
    client: document.getElementById('invClient').value,
    phone: document.getElementById('invPhone').value,
    service: document.getElementById('invService').value,
    tech: document.getElementById('invTech').value,
    pay: document.getElementById('invPay').value,
    amount: parseFloat(document.getElementById('invAmount').value) || 0,
    ts: Date.now()
  };
  if(!inv.date || !inv.time || !inv.client || !inv.tech || !inv.amount){
    return S.notify('Completa fecha, hora, cliente, t√©cnica y monto.');
  }
  state.invoices.push(inv);
  state.cfg.invoice.next++;
  state.lastInvId = inv.id;
  persistAll();
  renderBilling();
}

// Generar PDF de factura individual
document.getElementById('btnInvoicePDF').onclick = ()=>{
  const inv = state.invoices.find(i=> i.id === state.lastInvId);
  if(!inv){
    return S.notify('Primero guarda una factura.');
  }
  // Usa tu plantilla para PDF individual
  const html = `
    <html><head><meta charset="utf-8"><title>${inv.number}</title>
    <style>
      @page{ size:A4; margin:24mm; }
      body{ font-family:${state.cfg.font}; color:#111; }
      h1{ margin-bottom:8px; }
      table{ width:100%; border-collapse:collapse; font-size:14px; }
      th,td{ padding:8px; border:1px solid #ccc; text-align:left; }
      th{ background:#f5f5f5; }
    </style>
    </head><body>
      <h1>${state.cfg.invoice.title || 'Factura / Recibo'}</h1>
      <div>N√∫mero: ${inv.number}</div>
      <div>Fecha: ${inv.date} ${inv.time}</div>
      <div>Cliente: ${inv.client}</div>
      <div>T√©cnica: ${inv.tech}</div>
      <div>M√©todo: ${inv.pay}</div>
      <table>
        <thead><tr><th>Servicio</th><th>Monto</th></tr></thead>
        <tbody><tr><td>${inv.service || ''}</td><td>$${(+inv.amount).toFixed(2)}</td></tr></tbody>
        <tfoot><tr><th>Total</th><th>$${(+inv.amount).toFixed(2)}</th></tr></tfoot>
      </table>
      <div style="margin-top:20px;">${state.cfg.invoice.footer || ''}</div>
    </body></html>
  `;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

// Renderizar Cobros vista + tabla
function renderBilling(){
  refreshTechs();
  renderBillingTable();
  wireTechExportButtons();
}

// ===== Rendimiento / Analytics =====
function sumBy(arr,fn){ return arr.reduce((a,x)=> a + (+fn(x) || 0), 0); }
function renderAnalytics(){
  const range = document.getElementById('rangeKPI').value || 'month';
  const now = new Date();
  const start = range==='day' ? new Date(now.getFullYear(),now.getMonth(),now.getDate())
                : range==='week' ? S.addDays(now, -6)
                : new Date(now.getFullYear(), now.getMonth(), 1);

  const invInRange = state.invoices.filter(i=> new Date(i.date) >= start);
  const total = sumBy(invInRange, i=> i.amount);

  const byTech = {}; invInRange.forEach(i=> byTech[i.tech] = (byTech[i.tech]||0) + (+i.amount||0) );
  const byPay = {}; invInRange.forEach(i=> byPay[i.pay] = (byPay[i.pay]||0) + (+i.amount||0) );
  const bySrvCount = {}; invInRange.forEach(i=> bySrvCount[i.service] = (bySrvCount[i.service]||0) + 1 );

  const apInRange = state.appointments.filter(a=> new Date(a.date) >= start);
  const nos = apInRange.filter(a=> a.status==='no-show').length;
  const ok = apInRange.length - nos;

  const k = document.getElementById('kpis');
  if(k){
    k.innerHTML = '';
    const makeK = (title,val)=>{ const c = document.createElement('div'); c.className='card'; c.innerHTML = `<div style="color:var(--muted)">${title}</div><div style="font-size:26px;font-weight:800">${val}</div>`; k.appendChild(c); };
    makeK('Ingresos', `$${total.toFixed(2)}`);
    makeK('Citas', apInRange.length);
    makeK('No-shows', nos);
  }

  // Dibujo de gr√°ficas (si usas canvas)
  // Aqu√≠ necesitas librer√≠a o tu m√©todo para dibujar barras, etc.
  // Este fragmento asume que tienes drawBar(canvasId, labels, values, opts)

  const labelsTech = Object.keys(byTech);
  const valsTech = labelsTech.map(l=> byTech[l]);
  drawBar('chart1', labelsTech, valsTech, {title:'Ingresos por t√©cnica', barColors:labelsTech.map(()=>state.cfg.chartColors.tech)});

  const labelsSrv = Object.keys(bySrvCount);
  const valsSrv = labelsSrv.map(l=> bySrvCount[l]);
  drawBar('chart2', labelsSrv, valsSrv, {title:'Top servicios (conteo)', barColors:labelsSrv.map(()=>state.cfg.chartColors.service)});

  // Export Analytics PDF
  document.getElementById('btnExportAnalPDF').onclick = ()=> exportAnalyticsPDF({range, start, totals:{total, citas:apInRange.length, nos}});
}

// Export Analytics PDF
function exportAnalyticsPDF({range, start, totals}){
  const inv= state.invoices.filter(i=> new Date(i.date) >= start);
  const ap= state.appointments.filter(a=> new Date(a.date) >= start);
  const noShows = ap.filter(a=> a.status==='no-show').length;
  const ok = ap.length - noShows;

  const byTech = {};
  inv.forEach(i=> byTech[i.tech] = (byTech[i.tech]||0) + (+i.amount||0) );

  const byPay = {};
  inv.forEach(i=> byPay[i.pay] = (byPay[i.pay]||0) + (+i.amount||0) );

  const rowsTech = Object.entries(byTech).map(([k,v]) => `<tr><td>${k}</td><td style="text-align:right">$${v.toFixed(2)}</td></tr>`).join('');
  const rowsPay = Object.entries(byPay).map(([k,v]) => `<tr><td>${k}</td><td style="text-align:right">$${v.toFixed(2)}</td></tr>`).join('');

  const html = `
    <html><head><meta charset="utf-8"><title>Analytics</title>
    <style>
      @page{ size:A4; margin:12mm }
      body{ font-family:${state.cfg.font}; color:#111; }
      h1{ margin-bottom:8px; }
      .meta{ margin-bottom:12px; color:#555; }
      table{ width:100%; border-collapse:collapse; font-size:12px; }
      th,td{ border:1px solid #ccc; padding:6px; }
      th{ background:#f3f3f3; text-align:left; }
    </style>
    </head><body>
      <h1>Rendimiento ‚Äî ${range.charAt(0).toUpperCase()+range.slice(1)}</h1>
      <div class="meta">Desde: ${start.toISOString().slice(0,10)} ¬∑ Generado: ${new Date().toLocaleString()}</div>
      <h2>Ingresos por t√©cnica</h2>
      <table><thead><tr><th>T√©cnica</th><th style="text-align:right">Monto</th></tr></thead><tbody>${rowsTech}</tbody></table>
      <h2>Ingresos por m√©todo de pago</h2>
      <table><thead><tr><th>M√©todo</th><th style="text-align:right">Monto</th></tr></thead><tbody>${rowsPay}</tbody></table>
      <h2>Citas & No-shows</h2>
      <table><thead><tr><th>Tipo</th><th style="text-align:right">Cantidad</th></tr></thead><tbody>
        <tr><td>Citas realizadas</td><td style="text-align:right">${ap.length}</td></tr>
        <tr><td>No-shows</td><td style="text-align:right">${noShows}</td></tr>
      </tbody></table>
    </body></html>
  `;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

// ===== Logs =====
function log(type,msg){
  state.logs.push({id:S.uid(), type, msg, ts:Date.now(), user:state.session?.user || 'anon'});
  S.save('logs', state.logs);
}

function renderLogsTable(){
  const tbl = document.getElementById('tblLogs');
  if(!tbl) return;
  tbl.innerHTML = '<tr><th>Fecha</th><th>Usuario</th><th>Tipo</th><th>Mensaje</th></tr>' +
    state.logs.slice(-200).reverse().map(l=>`<tr><td>${S.toLocalDateTimeStr(new Date(l.ts))}</td><td>${l.user}</td><td>${l.type}</td><td>${l.msg}</td></tr>`).join('');
}

function exportLogsPDF(){
  const rowsHtml = state.logs.slice(-500).map(l=>`<tr><td>${S.toLocalDateTimeStr(new Date(l.ts))}</td><td>${l.user}</td><td>${l.type}</td><td>${l.msg}</td></tr>`).join('');
  const html = `
    <html><head><meta charset="utf-8"><title>Historial</title>
    <style>
      @page{ size:A4 landscape; margin:10mm }
      body{ font-family:${state.cfg.font}; color:#111; }
      table{ width:100%; border-collapse:collapse; font-size:12px; }
      th, td{ border:1px solid #ccc; padding:6px; }
      th{ background:#f3f3f3; text-align:left; }
    </style>
    </head><body>
      <h1>Historial de Logs</h1>
      <table><thead><tr><th>Fecha</th><th>Usuario</th><th>Tipo</th><th>Mensaje</th></tr></thead>
      <tbody>${rowsHtml}</tbody>
    </table>
    </body></html>
  `;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

// ===== Other helpers =====
S.isSameDay = (a, b) => a.toISOString().slice(0,10) === b.toISOString().slice(0,10);
S.toLocalDateTimeStr = d => {
  const dd = d;
  return dd.getFullYear() + '-' + S.pad(dd.getMonth()+1) + '-' + S.pad(dd.getDate())
    + ' ' + S.pad(dd.getHours()) + ':' + S.pad(dd.getMinutes());
};
S.addDays = (d,n)=> { const x = new Date(d); x.setDate(x.getDate()+n); return x; };

// ===== Configuraci√≥n: guardar estilos, branding, servicios, t√©cnicas etc. =====
function renderConfig(){
  // llenar campos
  document.getElementById('cfgSalonName').value = state.cfg.salonName;
  document.getElementById('cfgFont').value = state.cfg.font;
  document.getElementById('cfgBg').value = state.cfg.colors.bg;
  document.getElementById('cfgTopbar').value = state.cfg.colors.topbar;
  document.getElementById('cfgBtn').value = state.cfg.colors.btn;
  document.getElementById('cfgAccent').value = state.cfg.colors.accent;
  document.getElementById('cfgFooter').value = state.cfg.footer;
  refreshTechs();
  refreshServices();
  // Rellenar tabla servicios
  const tblSrv = document.getElementById('tblSrv');
  if(tblSrv){
    tblSrv.innerHTML = '<tr><th>Servicio</th><th>Precio</th><th></th></tr>' +
      state.services.map((s,i)=>`<tr><td>${s.name}</td><td>$${(+s.price).toFixed(2)}</td><td><button class="btn small" onclick="delSrv(${i})">Eliminar</button></td></tr>`).join('');
  }
  // T√©cnicas
  const ul = document.getElementById('techList');
  if(ul){
    ul.innerHTML = '';
    state.techs.forEach((t,i)=>{
      const li = document.createElement('li');
      li.textContent = t + ' ';
      const b = document.createElement('button');
      b.className='btn small danger';
      b.textContent='Eliminar';
      b.onclick = ()=>{
        state.techs.splice(i,1);
        persistAll();
        refreshTechs();
      };
      li.appendChild(b);
      ul.appendChild(li);
    });
  }
}

document.getElementById('btnAddSrv').onclick = ()=>{
  const name = document.getElementById('srvName').value.trim();
  const price = parseFloat(document.getElementById('srvPrice').value) || 0;
  if(!name) return S.notify('Nombre de servicio requerido');
  state.services.push({name, price});
  persistAll();
  refreshServices();
  document.getElementById('srvName').value='';
  document.getElementById('srvPrice').value='';
};

document.getElementById('btnAddTech').onclick = ()=>{
  const t = document.getElementById('techNew').value.trim();
  if(!t) return S.notify('Nombre de t√©cnica requerido');
  state.techs.push(t);
  persistAll();
  refreshTechs();
  document.getElementById('techNew').value='';
};

// ===== Backups =====
document.getElementById('btnSchedBackups').onclick = ()=> S.notify('Backups programados (simulado)');
document.querySelectorAll('[data-backup]').forEach(b=>{
  b.onclick = ()=>{
    const [what,freq] = b.dataset.backup.split(':');
    const data = what==='appointments'? state.appointments
                : what==='billing'? {invoices: state.invoices, noshows: state.noshows}
                : {};
    S.download(`${what}-${freq}-${Date.now()}.json`, JSON.stringify(data,null,2));
  };
});
document.getElementById('btnExportAll').onclick = ()=>{
  const dump = {
    session: state.session,
    cfg: state.cfg,
    users: state.users,
    menu: state.menu,
    techs: state.techs,
    services: state.services,
    appointments: state.appointments,
    invoices: state.invoices,
    noshows: state.noshows,
    logs: state.logs
  };
  S.download(`backup-total-${Date.now()}.json`, JSON.stringify(dump,null,2));
};
document.getElementById('importAll').onchange = e=>{
  const f = e.target.files[0];
  if(!f) return;
  f.text().then(t=>{
    const dump = JSON.parse(t);
    Object.assign(state, dump);
    persistAll();
    applyTheme();
    refreshTechs();
    refreshServices();
    renderBilling();
    renderAgenda();
    renderAnalytics();
    renderConfig();
  });
};

// ===== Inicializaci√≥n =====
window.onload = ()=>{
  applyTheme();
  buildMenu();
  refreshTechs();
  refreshServices();
  renderBilling(); // o lo que quieras mostrar por defecto
  renderAgenda();
  renderAnalytics();
  renderConfig();
  renderLogsTable();
  // Inicializar evento de export por t√©cnica
  wireTechExportButtons();
};

</script>
</body>
</html>
